<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상담 글 수정</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <style>
        body { 
            font-family: Arial; 
            background:#f0f2f5; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            min-height:100vh; 
        }
        .container { 
            background:#fff; 
            padding:30px; 
            border-radius:10px; 
            box-shadow:0 4px 12px rgba(0,0,0,0.1); 
            width:100%; 
            max-width:500px; 
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group { 
            margin-bottom:15px; 
        }
        .form-group label { 
            display:block; 
            margin-bottom:5px; 
            font-weight:bold; 
        }
        .form-group input, .form-group select, .form-group textarea {
            width:100%; 
            padding:10px; 
            border:1px solid #ccc; 
            border-radius:5px; 
            box-sizing:border-box;
        }
        .form-group textarea {
            min-height:120px;
        }
        .submit-btn { 
            background:#3498db; 
            color:#fff; 
            padding:12px; 
            border:none; 
            border-radius:5px; 
            cursor:pointer; 
            width:100%; 
            font-weight:bold; 
            margin-top:10px;
        }
        .submit-btn:hover { 
            background:#2980b9; 
        }
        .cancel-btn {
            background: #fff;
            color: #555;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px; 
        }
        .cancel-btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <h2>상담 글 수정</h2>
    <form @submit.prevent="fnEditPost">
        <div class="form-group">
            <label>작성자</label>
            <input type="text" v-model="info.writer" readonly>
        </div>
        <div class="form-group">
            <label>글 제목</label>
            <input type="text" v-model="info.TITLE" required maxlength="50" placeholder="제목을 입력하세요">
        </div>
        <div class="form-group">
            <label>게시글 종류</label>
            <select v-model="info.POST_TYPE" required>
                <option v-for="type in availableTypes" :key="type" :value="type">
                    {{ type }}
                </option>
            </select>
        </div>
        <div class="form-group" v-if="info.POST_TYPE === '문의'">
            <label>문의 유형</label>
            <select v-model="info.CATEGORY" required>
                <option v-for="cat in availableCategories" :key="cat" :value="cat">{{ cat }}</option>
            </select>
        </div>
        <div class="form-group">
            <label>글 내용</label>
            <textarea v-model="info.CONTENTS" required maxlength="2000" placeholder="내용을 입력하세요"></textarea>
        </div>
        <button type="submit" class="submit-btn">수정 완료</button>
        <button type="button" class="cancel-btn" @click="goBack">취소</button>
    </form>
</div>
</body>
</html>
<script>
    const app = Vue.createApp({
        data() {
            return {
                info: {},
                availableTypes: [],
                availableCategories: ["매물관련", "계약/금융관련", "기타 문의"],
                consultationId: ""
            }
        },
        methods: {
            goBack() {
                window.location.href = "main.html?menu=consultations";
            },
            setWriterAndTypes(user){
                let self = this;
                if(!user){
                    self.info.writer = "비회원";
                    self.availableTypes = ["문의"];
                } else {
                    const role = user.role || user.ROLE;
                    const nickname = user.nickName || user.NICKNAME || user.NAME;

                    self.info.writer = nickname || "비회원";

                    if(role === 10 || role === "10"){
                        self.availableTypes = ["공지", "답변"];
                    } else {
                        self.availableTypes = ["문의"];
                    }
                }
            },
            fnEditPost() {
                const self = this;
                if(!self.info.TITLE  || !self.info.CONTENTS){
                    alert("필수 항목을 입력해주세요.");
                    return;
                }

                const param = {
                    consultationId: self.consultationId, 
                    title: self.info.TITLE, 
                    postType: self.info.POST_TYPE, 
                    category: self.info.CATEGORY,
                    contents: self.info.CONTENTS, 
                    status: self.info.STATUS || "상담대기"
                };

                console.log(param);

                $.ajax({
                    url: "http://localhost:3009/consultations/update",
                    type: "GET",
                    dataType: "json",
                    data: param,
                    success: function(data){
                        alert("글이 수정되었습니다!");
                        window.location.href = "main.html?menu=consultations";
                    },
                    error: function(err){
                        console.error(err);
                        alert("수정 실패");
                    }
                });
            },
            fetchPostInfo(){
                const self = this;
                $.ajax({
                    url: "http://localhost:3009/consultations/info",
                    type: "GET",
                    dataType: "json",
                    data: { consultationId : self.consultationId },
                    success: function(data){
                        if(data && data.result === "success" && data.info){            
                            self.info = data.info;

                            self.setWriterAndTypes({
                                role: data.info.CLIENT_ROLE || 0,
                                nickName: data.info.CLIENT_NICKNAME
                            });
                        }
                    },
                    error: function(err){
                        console.error("consultations/info 호출 실패:", err);
                    }
                });
            }
        },
        mounted(){
            let self = this;
            const params = new URLSearchParams(window.location.search);
            const consultationId = params.get('consultationId');
            if (consultationId) {
                self.consultationId = consultationId;
                self.fetchPostInfo();
            }
        }
    });

    app.mount('#app');
</script>
